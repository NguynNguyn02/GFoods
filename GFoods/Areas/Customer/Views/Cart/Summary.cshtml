@model ShoppingCartVM

@{
    var info = System.Globalization.CultureInfo.GetCultureInfo("vi-VN");
}

<form method="post">
    <br />
    <div class="container">
        <div class="card">
            <div class="card-header bg-dark text-light ml-0">
                <div class="row container">
                    <div class="col-6">
                        <i class="fa fa-shopping-cart"></i> &nbsp;
                        Chi tiết đơn hàng
                    </div>
                    <div class="col-6 text-end">
                        <a asp-action="Index" class="btn btn-outline-info btn-sm">Quay lại giỏ hàng</a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="container rounded p-2">
                    <div class="row">
                        <div class="col-12 col-lg-6 pb-4">
                            <div class="row">
                                <h4 class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="text-info">Thông tin:</span>
                                </h4>
                            </div>
                            <div class="row my-1">
                                <div class="col-3">
                                    <label>Name</label>
                                </div>
                                <div class="col-9">
                                    <input asp-for="OrderHeader.Name" class="form-control" />
                                    <span asp-validation-for="OrderHeader.Name" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="row my-1">
                                <div class="col-3">
                                    <label>Phone</label>
                                </div>
                                <div class="col-9">
                                    <input asp-for="OrderHeader.PhoneNumber" class="form-control" />
                                    <span asp-validation-for="OrderHeader.PhoneNumber" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="row my-1">
                                <div class="col-3">
                                    <label>Street Address</label>
                                </div>
                                <div class="col-9">
                                    <input asp-for="OrderHeader.StreetAddress" class="form-control" />
                                    <span asp-validation-for="OrderHeader.StreetAddress" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="row my-1">
                                <div class="col-3">
                                    <label>City</label>
                                </div>
                                <div class="col-9">
                                    <input asp-for="OrderHeader.City" class="form-control" />
                                    <span asp-validation-for="OrderHeader.City" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="row my-1">
                                <div class="col-3">
                                    <label>State</label>
                                </div>
                                <div class="col-9">
                                    <input asp-for="OrderHeader.State" class="form-control" />
                                    <span asp-validation-for="OrderHeader.State" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="row my-1">
                                <div class="col-3">
                                    <label>Postal Code</label>
                                </div>
                                <div class="col-9">
                                    <input asp-for="OrderHeader.PostalCode" class="form-control" />
                                    <span asp-validation-for="OrderHeader.PostalCode" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Hình thức thanh toán</label>
                                <select class="form-control" name="TypePayment" id="drTypePayment">
                                    <option value="1" selected>COD</option>
                                    <option value="2">Chuyển khoản</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-12 col-lg-5 offset-lg-1">
                            <h4 class="d-flex justify-content-between align-items-center mb-3">
                                <span class="text-info">Đơn hàng:</span>
                            </h4>
                            <ul class="list-group mb-3">
                                @foreach (var details in Model.ShoppingCartList)
                                {
                                    <li class="list-group-item d-flex justify-content-between">
                                        <div>
                                            <h6 class="my-0">@details.Product.Title</h6>
                                            <small class="text-muted">Số lượng: @details.Count</small>
                                        </div>
                                        <span class="text-muted">@((details.Price * details.Count).ToString("#,### VNĐ", info)) </span>
                                    </li>
                                }
                                <li class="list-group-item d-flex justify-content-between bg-light">
                                    <small class="text-info fw-bold">Tổng tiền</small>
                                    <strong class="text-info">@Model.OrderHeader.OrderTotal.ToString("#,### VNĐ", info)</strong>
                                </li>

                            </ul>
                            <input type="button" id="qrcode" class="btn btn-primary">
                            @Model.OrderHeader.ApplicationUser.Id
                            </input>
                            <img src="#" class="item_test" />
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card-footer">
                <div class="row">
                    <div class="col-12 col-md-8 pt-2">
                        <p style="color:maroon; font-size:14px;">
                            Estimate Arrival Date:
                            @DateTime.Now.AddDays(7).ToShortDateString() - @DateTime.Now.AddDays(14).ToShortDateString()
                        </p>
                    </div>
                    <div class="col-12 col-md-4">
                        <input type="submit" name="payment" value="Đặt hàng COD" class="btn btn-primary form-control" />
                        @if (User.IsInRole("Customer"))
                        {
                            <input type="submit" name="payment" value="Thanh toán bằng VNPAY" class="btn btn-primary form-control" />
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

@section scripts {
    <script>
        let My_Bank = {
            BANK_ID: "MB",
            ACCOUNT_NO: "8290137914023",
            TEMPLATE: "compact2"
        };
        const qrImg = document.querySelector(".item_test");
        var contentText = Math.floor(Math.random() * 100) * Math.floor(Math.random() * 100) * Math.floor(Math.random() * 100);
        $(document).ready(function () {
            $('body').on('click', '#qrcode', function () {
                let paidPrice = @Model.OrderHeader.OrderTotal;
                let paidContent = `GD` + contentText;
                let qr = `https://img.vietqr.io/image/${My_Bank.BANK_ID}-${My_Bank.ACCOUNT_NO}-${My_Bank.TEMPLATE}.png?amount=${paidPrice}&addInfo=${paidContent}`;
                qrImg.src = qr;
                setTimeout(() => {
                    setInterval(() => {
                        checkPair(paidPrice, paidContent);
                    }, 1000);
                }, 10000);
            });
            let isSuccess = false;
            async function checkPair(price, content) {
                if (isSuccess) {
                    return;
                } else {
                    try {
                        const response = await fetch(
                            "https://script.googleusercontent.com/macros/echo?user_content_key=0b5XsvekwDnKOt1PZJovG1ZGIPrZx3yBePPqm87460zbztuKHNcN0_aDs3oK6D3aG7UkdbMNfflC0EHrJN2R7LqjI7yLG7TLm5_BxDlH2jW0nuo2oDemN9CCS2h10ox_1xSncGQajx_ryfhECjZEnP07XCWoNrHBGXIJSNNkrE6y1XXlCHNglL07Qm_A43M9mw1ioVrToqQb_ebMfAliHUzKpg4piWtSrwyszSGt52ecrsuLqI4OQtz9Jw9Md8uu&lib=MJGfEvd_fNRVIWcTCkJ8PqKlt3FBmEMnE"
                        );
                        const data = await response.json();
                        const lastPaid = data.data[data.data.length - 1];
                        lastPrice = lastPaid["Giá trị"];
                        lastContent = lastPaid["Mô tả"];
                        if (lastPrice >= price && lastContent.includes(content)) {
                            alert("Thanh toán thành công");
                            isSuccess = true;
                        } else {
                            console.log("Không thành công")
                        }
                    } catch {
                        console.log("Lỗi")
                    }
                }
            }
        });

    </script>
}
